<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>VolleyGroups</title>
	</head>
	<body>
		<div id="app">
			<div id="appbar">
				<p id="title">VolleyGroups</p>
				<button id="closecircle"></button>
				<button id="minimizecircle"></button>
			</div>
			<div id="content">
				<div id="toprow">
					<button id="nextroundbtn">Next Round</button>
					<button id="leaderboardbtn">Leaderboard</button>
				</div>
				<div id="games"></div>
			</div>
		</div>
	</body>
</html>
<script>
	class Game {
		constructor() {
			this.teams = [
				{
					players: [],
					score: 0,
				},
				{
					players: [],
					score: 0,
				},
			];
			this.field = "";
		}
	}

	class Player {
		constructor() {
			this.teammates = [];
			this.field = "";
			this.score = {
				us: 0,
				them: 0,
			};
		}
	}
	let data;
	let groups;
	document.addEventListener("DOMContentLoaded", async () => {
		const { invoke } = window.__TAURI__;
		const app = document.getElementById("app");
		const appbar = document.getElementById("appbar");
		const title = document.getElementById("title");
		const closecircle = document.getElementById("closecircle");
		const minimizecircle = document.getElementById("minimizecircle");
		const nextroundbtn = document.getElementById("nextroundbtn");
		const leaderboardbtn = document.getElementById("leaderboardbtn");

		const players = JSON.parse(localStorage.getItem("players"));
		groups = localStorage.getItem("groups");

		data = { players: {}, games: [] };

		players.forEach((player) => {
			data.players[player] = {
				games: [],
			};
		});
		console.log(data);

		appbar.addEventListener("mousedown", async (e) => {
			if (e.target != appbar && e.target != title) return;
			invoke("drag_window");
		});

		closecircle.addEventListener("click", async () => {
			invoke("close_window");
		});

		minimizecircle.addEventListener("click", async () => {
			invoke("minimize_window");
		});

		leaderboardbtn.addEventListener("click", () => {
			console.log(getLeaderboard());
		});
		const games = document.getElementById("games");
		const gamelist = getGames();
		console.log(gamelist);
		gamelist.forEach((team, index) => {
			let table = document.createElement("table");
			let caption = document.createElement("caption");
			caption.innerText = `Team ${index + 1}`;
			table.appendChild(caption);

			team.forEach((player) => {
				let tr = document.createElement("tr");
				let td = document.createElement("td");
				console.log(player);
				td.innerText = player;
				tr.appendChild(td);
				table.appendChild(tr);
			});

			let tr = document.createElement("tr");
			let td = document.createElement("td");
			let input = document.createElement("input");
			input.type = "number";
			input.placeholder = "score";
			td.appendChild(input);
			tr.appendChild(td);
			table.appendChild(tr);

			games.appendChild(table);
		});
	});

	function getGames() {
		const players = data.players;
		const games = data.games;
		const playerkeys = Object.keys(players);
		let uneven = playerkeys.length % groups;
		console.log(uneven);
		console.log(playerkeys);
		console.log(groups);
		console.log(games.length);
		if (games.length == 0) {
			// first game
			let teams = [];
			for (let i = 0; i < Math.floor(playerkeys.length / groups); i++) {
				let team = [];
				for (let j = 0; j < groups; j++) {
					let player = playerkeys[i * groups + j];
					team.push(player);
				}
				teams.push(team);
			}
			for (let i = 0; i < uneven; i++) {
				let team = [];
				for (let j = 0; j < groups; j++) {
					let player = playerkeys[i * groups + j];
					team.push(player);
				}
				teams.push(team);
			}
			return teams;
		}
		let lastgame = games.at(-1);
		let lastteams = lastgame.teams;
		let leaderboards = getLeaderboard();
		console.log(leaderboards);
	}

	function getLeaderboard() {
		const players = data.players;
		const playerkeys = Object.keys(players);
		let leaderboard = [];
		playerkeys.forEach((player) => {
			let games = players[player].games;
			let score = 0;
			let wins = 0;
			let gamesplayed = games.length;
			games.forEach((game) => {
				score += game.score;
				if (game.score > 0) wins++;
			});
			leaderboard.push({
				player: player,
				score: score,
				wins: wins,
				gamesplayed: gamesplayed,
			});
		});
		return leaderboard.sort((a, b) => {
			if (a.winds > b.wins) return -1;
			if (a.wins < b.wins) return 1;
			if (a.score > b.score) return -1;
			if (a.score < b.score) return 1;
			if (a.gamesplayed < b.gamesplayed) return -1;
			if (a.gamesplayed > b.gamesplayed) return 1;
			return 0;
		});
	}
</script>
<style>
	* {
		user-select: none;
		margin: 0;
		padding: 0;
		box-sizing: inherit;
		@font-face {
			font-family: "Roboto";
			src: url("assets:///assets/Roboto-Bold.ttf") format("truetype");
		}
		font-family: "Roboto";
	}
	:root {
		/* Light theme variables */
		--light-bg: #ffffff;
		--light-text: #1a1a1a;
		--light-accent: #4dabf7;
		--light-surface: #f5f5f5;
		--light-border: #e0e0e0;
		--light-appbar: #f0f0f0;

		/* Dark theme variables */
		--dark-bg: #1a1a1a;
		--dark-text: #ffffff;
		--dark-accent: #4dabf7;
		--dark-surface: #2d2d2d;
		--dark-border: #404040;
		--dark-appbar: #161616;

		/* Default theme (light) */
		--bg-color: var(--light-bg);
		--text-color: var(--light-text);
		--accent-color: var(--light-accent);
		--surface-color: var(--light-surface);
		--border-color: var(--light-border);
		--appbar-color: var(--light-appbar);
		--width: 700px;
		--height: 400px;
	}

	@media (prefers-color-scheme: dark) {
		:root {
			--bg-color: var(--dark-bg);
			--text-color: var(--dark-text);
			--accent-color: var(--dark-accent);
			--surface-color: var(--dark-surface);
			--border-color: var(--dark-border);
			--appbar-color: var(--dark-appbar);
		}
	}

	/* Dark theme class for manual toggle */
	.dark-theme {
		--bg-color: var(--dark-bg);
		--text-color: var(--dark-text);
		--accent-color: var(--dark-accent);
		--surface-color: var(--dark-surface);
		--border-color: var(--dark-border);
		--appbar-color: var(--dark-appbar);
	}
	.light-theme {
		--bg-color: var(--light-bg);
		--text-color: var(--light-text);
		--accent-color: var(--light-accent);
		--surface-color: var(--light-surface);
		--border-color: var(--light-border);
		--appbar-color: var(--light-appbar);
	}
	html,
	body {
		background: transparent;
		width: var(--width);
		height: var(--height);
		box-sizing: border-box;
		overflow: hidden;
		margin: 0;
		padding: 0;
		color: var(--text-color);
	}
	#app {
		width: var(--width);
		height: var(--height);
		background: var(--bg-color);
		border-radius: 15px;
	}
	#appbar {
		width: var(--width);
		height: 30px;
		background: var(--appbar-color);
		border-radius: 15px 15px 0 0;
	}
	#closecircle {
		width: 12px;
		height: 12px;
		position: fixed;
		top: 9px;
		left: 12px;
		border-radius: 50%;
		background: #ff5f57;
		border: none;
		cursor: pointer;
		box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.15);
	}
	#closecircle:hover {
		filter: brightness(0.9);
	}
	#closecircle:active {
		filter: brightness(0.8);
	}
	#minimizecircle {
		width: 12px;
		height: 12px;
		position: fixed;
		top: 9px;
		left: 32px;
		border-radius: 50%;
		background: #ffbd2e;
		border: none;
		cursor: pointer;
		box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.15);
	}
	#minimizecircle:hover {
		filter: brightness(0.9);
	}
	#minimizecircle:active {
		filter: brightness(0.8);
	}
	#title {
		position: fixed;
		top: 7px;
		left: 50%;
		transform: translateX(-50%);
		font-size: 14px;
		font-weight: 600;
	}
	#content {
		width: 700px;
		height: calc(100% - 30px);
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
        box-sizing: border-box;
	}
	#toprow {
		width: 100%;
		height: 50px;
		display: flex;
		justify-content: space-around;
		align-items: center;
	}
	#nextroundbtn {
		width: 300px;
		height: 40px;
		background: var(--accent-color);
		color: var(--text-color);
		border: none;
		border-radius: 5px;
		cursor: pointer;
	}
	#leaderboardbtn {
		width: 300px;
		height: 40px;
		background: var(--accent-color);
		color: var(--text-color);
		border: none;
		border-radius: 5px;
		cursor: pointer;
	}
	#games {
		width: 100%;
		height: calc(100% - 80px);
		display: grid;
		grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        padding: 20px;
        overflow-y: auto;
        scrollbar-width: none;
	}
	table {
		border-collapse: collapse;
		width: 100%;
		margin: 0 auto;
		border: 2px solid var(--accent-color);
	}
	caption {
		padding: 10px;
		font-weight: bold;
		color: var(--text-color);
		background: var(--surface-color);
		border: 2px solid var(--accent-color);
		border-bottom: none;
	}

	td {
		border: 1px solid var(--accent-color);
		padding: 10px;
		text-align: center;
	}
	td input {
		width: 100%;
		height: 30px;
		border: none;
		background: transparent;
		border: none;
		outline: none;
		color: var(--text-color);
		text-align: center;
	}
	input[type="number"] {
		-webkit-appearance: textfield;
		-moz-appearance: textfield;
		appearance: textfield;
	}

	input[type="number"]::-webkit-inner-spin-button,
	input[type="number"]::-webkit-outer-spin-button {
		-webkit-appearance: none;
		margin: 0;
	}
</style>
